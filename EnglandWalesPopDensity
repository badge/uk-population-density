#England and Wales Population Density Map
library(rgdal)
library(maptools)
library(ggplot2)
library(foreign)
library(dplyr)

#set working directory
setwd("C:\\Users\\LiY\\Desktop\\Distribution")

#import shapefile
myshape<-readShapeSpatial("C:\\Users\\LiY\\Desktop\\Distribution\\Districts.shp")
 
#convert format
mydf<-fortify(myshape)

#change the id number so it starts from 1 instead of 0
newid<-as.numeric(mydf$id)
newid = newid +1
#replace the new column with the old one and then match
mydf[["id"]] <- newid

#import dbf file
disid<-read.dbf("Districts.dbf")
#add ID column into the data
disid$id <- seq.int(nrow(disid))
#rename column 1 to density
colnames(disid)[1] <- "district"

#import csv file
my_data<-read.csv("PostCodeDistricts.csv")
#change density to be based on km2
newdensity <-my_data[5]/(my_data[11]*0.01)
#replace the new density column with the old one
my_data[["density"]] <- newdensity
#rename district
colnames(my_data)[3]<-"district"

#join tables to get id in the population density table
districtid <- merge(x = mydf, y = disid, by = "id", all.x = TRUE)
#left join
table<- merge.data.frame(districtid, my_data, by = "district", all.districtid=TRUE)  #data ready!

#join tables to select England and Wales region only
innerjoin<-merge.data.frame(districtid, my_data, by = "district", all.districtid=TRUE)
#now the shapefile for England and Wales
mydff <-innerjoin[, c(3, 4,5,6,7,2,8)]

#need this to remove background and outline of graph
ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()
)

map_pop_density <- ggplot(data = mydff, mapping = aes(x = long, y = lat, group = group) ) + 
  coord_fixed(1.3) + 
  geom_polygon(aes(x=long,y=lat, group=group, fill=density), data=table) +
  theme_bw() +
  theme(legend.text=element_text(size=rel(0.6)),legend.position = 'bottom')+
   guides(fill = guide_colorbar(title = "Population Density",
                             label.position = "bottom",
                             title.position = "top", title.vjust = 1,
                             label = TRUE,
                             draw.ulim = TRUE,
                             draw.llim = TRUE,
                             # draw border around the gradient legend
                             frame.colour = "black",
                             ticks = TRUE, 
                             barwidth = 20,
                             barheight = 1.2, 
                             direction = 'horizontal')) +
  ditch_the_axes 

map_pop_density

map_pop_density +scale_fill_gradientn(name = "Population Density", colours = rev(rainbow(6)),
                         breaks = c(10,100, 250, 500, 1000, 2500, 5000,23390),
                         trans = "log10") + ggtitle("England and Wales Population Density Map")
				
						 
